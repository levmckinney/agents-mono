apiVersion: batch/v1
kind: Job
metadata:
  name: sweep-__SWEEP_ID__-worker-__WORKER_ID__
  labels:
    kueue.x-k8s.io/queue-name: __QUEUE_NAME__
    sweep-id: __SWEEP_ID__
    worker-id: __WORKER_ID__
spec:
  suspend: true  # Required for Kueue to manage scheduling
  backoffLimit: 0
  completions: 1
  parallelism: 1
  podFailurePolicy:
    rules:
    - action: Ignore
      onPodConditions:
      - type: DisruptionTarget
  template:
    metadata:
      labels:
        sweep-id: __SWEEP_ID__
        worker-id: __WORKER_ID__
    spec:
      priorityClassName: __PRIORITY_CLASS__
      containers:
        - name: worker
          image: __IMAGE__
          command:
            - /bin/bash
            - -c
            - |
              set -e
              git clone __UPSTREAM_REPO__ .
              git fetch --all
              git checkout "__COMMIT_HASH__"
              git submodule update --recursive
              uv venv --python 3.11 --system-site-packages .venv
              source .venv/bin/activate
              uv sync --active
              uv pip install --upgrade -e .  # Ensure local package is installed
              which python
              export PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True
              python -m launcher.worker --job-queue-path __JOB_QUEUE_PATH__ --worker-id __WORKER_ID__ --parallel-jobs __PARALLEL_JOBS__
          resources:
            requests:
              cpu: __CPU__
              memory: __MEMORY__
            limits:
              nvidia.com/gpu: __GPU__
          env:
          - name: SWEEP_DIR
            value: __SWEEP_BASE_DIR__
          - name: XDG_CACHE_HOME
            value: /node-local-cache/cache
          - name: OMP_NUM_THREADS
            value: "__CPU__"
          - name: WANDB_START_METHOD
            value: thread
          - name: GIT_ASKPASS
            value: "true"
          - name: GITHUB_PAT
            valueFrom:
              secretKeyRef:
                name: github-credentials
                key: pat
          - name: GIT_CONFIG_PARAMETERS
            value: "'credential.https://github.com.username=$(GITHUB_PAT)'"
          - name: HF_TOKEN
            valueFrom:
              secretKeyRef:
                name: huggingface
                key: token
          - name: WANDB_ENTITY
            value: levmckinney
          - name: WANDB_API_KEY
            valueFrom:
              secretKeyRef:
                name: wandb
                key: api-key
          - name: ANTHROPIC_API_KEY
            valueFrom:
              secretKeyRef:
                name: anthropic
                key: api-key
          volumeMounts:
          - name: devbox-storage
            mountPath: /home/dev
          - name: node-local-cache
            mountPath: /node-local-cache/cache
          - name: dshm
            mountPath: /dev/shm
          workingDir: /workspace
      volumes:
      - name: devbox-storage
        persistentVolumeClaim:
          claimName: "vast-__PROJECT_PVC__"
      - name: node-local-cache
        persistentVolumeClaim:
          claimName: "local-__PROJECT_PVC__"
      - name: dshm
        emptyDir:
          medium: Memory
          sizeLimit: 10Gi
      imagePullSecrets:
      - name: docker
      restartPolicy: Never